# EdgeSpark Backend

Hono + Drizzle ORM on Cloudflare Workers. Your code goes in `src/index.ts`.

## Project Structure

```
src/
├── index.ts              # YOUR CODE: Define routes here
└── __generated__/        # AUTO-GENERATED by `edgespark pull schema`
    ├── index.ts          # Barrel export - re-exports all schemas
    ├── db_schema.ts      # Drizzle tables - use for queries
    ├── db_relations.ts   # Drizzle relations - use for joins
    ├── db_raw_schema.sql # Raw SQLite DDL (triggers, views, FTS)
    ├── storage_schema.ts # Storage buckets - type-safe bucket access
    └── server-types.d.ts # SDK types - Client, AuthClient, StorageClient, etc.
```

> **Note:** The `__generated__/` folder is created automatically by `edgespark pull schema` or `edgespark init`. Do not edit these files - they are regenerated on each pull.

## Files to Read (MUST read before coding)

| When | Read |
|------|------|
| **Always** | `src/__generated__/server-types.d.ts` - **SDK types, don't guess!** |
| Starting any task | `src/__generated__/db_schema.ts` - understand data model first |
| Working with files | `src/__generated__/storage_schema.ts` - available buckets |
| Understanding raw DDL | `src/__generated__/db_raw_schema.sql` - triggers, views, FTS |

## Code Structure

Create your Hono app and return it:

```typescript
import { Hono } from "hono";
import type { Client } from "@sdk/server-types";
import { tables, buckets } from "@generated";
import { eq, desc, asc, and, or, sql } from "drizzle-orm";
// More operators: like, gt, lt, gte, lte, isNull, inArray, between

export async function createApp(
  edgespark: Client<typeof tables>
): Promise<Hono> {
  const app = new Hono();
  // YOUR ROUTES HERE
  return app;
}
```

## Rules

1. Always return the app at the end of `createApp()`
2. All routes start with `/api`
3. Use Drizzle ORM, not raw SQL (except FTS5, triggers, virtual tables)
4. Use `.returning()` for inserts when you need the ID
5. Always check null after `storage.get()` - files may not exist
6. Don't use `db.transaction()` - use `db.batch([...])` instead for atomic operations
7. Don't create BLOB columns - use TEXT for Storage URIs instead
8. Keep rows small (<10KB) - large data (files, images, big JSON) goes in Storage
9. Create indexes for WHERE/JOIN columns, but don't over-index (slows writes)
10. **Don't guess types** - read `@sdk/server-types` first, use what you see not what you assume
11. **Use presigned URLs for clients** - `s3://` URIs are internal storage references, clients need presigned URLs to upload/download

## Quick Examples

```typescript
// Database
await edgespark.db.select().from(tables.users).where(eq(tables.users.id, 1));
await edgespark.db.insert(tables.users).values({ name: "Alice" }).returning({ id: tables.users.id });
await edgespark.db.update(tables.users).set({ name: "Bob" }).where(eq(tables.users.id, 1));
await edgespark.db.delete(tables.users).where(eq(tables.users.id, 1));

// Storage
await edgespark.storage.from(buckets.uploads).put("file.txt", buffer);
const file = await edgespark.storage.from(buckets.uploads).get("file.txt");
if (!file) return c.json({ error: "Not found" }, 404);

// S3 URIs - store file references in database (not client-accessible URLs)
const uri = edgespark.storage.toS3Uri(buckets.avatars, "path/file.jpg");  // "s3://avatars/path/file.jpg"
const { bucket, path } = edgespark.storage.fromS3Uri(uri);                 // Parse back to bucket + path
// For client downloads, generate presigned URL: await edgespark.storage.from(bucket).createPresignedGetUrl(path)

// Batch operations (atomic - all succeed or all rollback)
const results = await edgespark.db.batch([
  edgespark.db.insert(tables.users).values({ name: "Alice" }).returning(),
  edgespark.db.update(tables.users).set({ name: "Bob" }).where(eq(tables.users.id, 1)),
  edgespark.db.select().from(tables.users),
]);
// results[0] = insert result, results[1] = update result, results[2] = select result
```

## CLI Notifications

EdgeSpark CLI shows notifications before command output:
- **CLI update available**: Run the suggested command to update
- **SDK types outdated**: Run `edgespark pull types`, then re-read the file

Always follow the `Run:` suggestions when you see notifications.

## SDK Types Management

Types are in `src/__generated__/server-types.d.ts`.

To update types:
```bash
edgespark pull types
```
Then re-read: `src/__generated__/server-types.d.ts`

To check if types are stale:
```bash
edgespark pull types --check
```

## Commands

```bash
npm install           # Install dependencies
edgespark deploy      # Build and deploy (CLI handles build)
edgespark pull types  # Pull latest SDK types
edgespark pull schema # Pull database and storage schemas
npm run typecheck     # Local type checking (optional)
```
